# -- Setup --
FROM ghcr.io/astral-sh/uv:python3.13-bookworm AS builder

WORKDIR /app

# Copy only dependency files first for efficient caching
COPY ../../pyproject.toml ../../uv.lock ./

# Install third-party dependencies
RUN uv sync --frozen --no-install-project

# Now copy the entire source code
COPY ../.. .

# -- Build --
FROM builder AS build

WORKDIR /app

RUN uv build --package rest_api

# --- Runtime Stage ---
FROM python:3.13-slim AS runtime

WORKDIR /app

# Copy built wheel from build stage
COPY --from=build /app/dist/*.whl ./

# Install the wheel
RUN pip install --no-cache-dir ./*.whl

# Expose app port
EXPOSE 8000

# Start FastAPI
CMD ["uvicorn", "time_series.rest_api.main:app", "--host", "0.0.0.0", "--port", "8000"]
