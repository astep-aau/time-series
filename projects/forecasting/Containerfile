# -- Setup --
FROM ghcr.io/astral-sh/uv:python3.13-bookworm AS builder

WORKDIR /app

# Copy only dependency files first for efficient caching
COPY ../../pyproject.toml ../../uv.lock ./

# Install third-party dependencies
RUN uv sync --frozen --no-install-project

# Now copy the entire source code
COPY ../.. .

# -- Build --
FROM builder AS build

WORKDIR /app

RUN uv build --package forecasting

# --- Runtime Stage ---
FROM python:3.13-slim AS runtime

WORKDIR /app

# Copy built wheel from build stage
RUN pip install --no-cache-dir psycopg2-binary

COPY --from=build /app/dist/*.whl ./

# Install the wheel
RUN pip install --no-cache-dir ./*.whl

# Install multipart
RUN pip install --no-cache-dir python-multipart

# Expose app port
EXPOSE 8000

ENTRYPOINT []


# Start FastAPI
CMD ["python3", "-m", "uvicorn", "time_series.outlier_detection.main:app", "--host", "0.0.0.0", "--port", "8000"]
